package cn.sirbox.controller;

import java.io.File;
import java.util.Date;
import java.util.List;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.multipart.MultipartFile;

import cn.sirbox.model.Dept;
import cn.sirbox.model.Result;
import cn.sirbox.model.UserU;
import cn.sirbox.model.page;
import cn.sirbox.service.impl.DeptService;
import cn.sirbox.service.impl.UserUService;
import net.sf.json.JSONArray;

/**
 * Created by X201 on 2016/8/26 0026.
 */
@Controller
@RequestMapping("/user")
public class UserUController {


    @Autowired
    private UserUService userUService;

    @Autowired
    private DeptService deptService;
    //进入主页面
    @RequestMapping("/index")
    public String index(HttpServletRequest request) {

        return "index";
    }
    @RequestMapping("/top")
    public String top(HttpServletRequest request) {
        UserDetails userDetails = (UserDetails) SecurityContextHolder.getContext()  
                .getAuthentication()  
                .getPrincipal();  
              
    	HttpSession session=request.getSession();
    	UserU userU=userUService.getUserUByName(userDetails.getUsername());
    	session.setAttribute("userU", userU);
        return "_top";
    }
    @RequestMapping("/right")
    public String right() {
        
        return "_left";
    }
    @RequestMapping("/left")
    public String left() {
        
        return "_right";
    }
    //进入注册页面
    @RequestMapping("/register")
    public String register(Model model) {
    	List<UserU> useru=userUService.getAllUserU();
		List<Dept> dept=deptService.getAllDept();
		StringBuffer sn1=new StringBuffer();
		sn1.append("[");
		sn1=hh(sn1,dept,0);
		sn1.deleteCharAt(sn1.length()-1);
		sn1.append("]");
		String ss=sn1.toString();
		model.addAttribute("ztreeno",ss);
        return "register";
    }

    @RequestMapping("/login")
    public String login(HttpServletRequest request) {

            return "login";

    }

    @RequestMapping("/aj")
    @ResponseBody
    public String aj(String uname) {

        UserU u=userUService.getUserUByName(uname);
        if(u==null){
            return "success";
        }

        return "";
    }
    
    @RequestMapping("/addu")
    public String register(UserU userU, String[] power,Model model,@RequestParam(value = "photo", required = false) MultipartFile file,HttpServletRequest request){
    	
        String path = request.getSession().getServletContext().getRealPath("upload");  
        
        
        String fileName = new Date().getTime()+".jpg";  
          
        File targetFile = new File(path, fileName);  
        if(!targetFile.exists()){  
            targetFile.mkdirs();  
        }  
  
        //保存  
        try {  
            file.transferTo(targetFile);  
        } catch (Exception e) {  
            e.printStackTrace();  
        }
        String fileUrl=request.getContextPath()+"/upload/"+fileName;
    	if(power!=null){
    		for(int i=0;i<power.length;i++){
                userUService.addUserUPower(userU.getUname(),power[i]);
            }
    	}
    	userU.setImgsrc(fileUrl);
        userUService.insertSelective(userU);
        Integer count=userUService.countByExample();
        Integer page1=count%(page.pagenumber)==0?count/(page.pagenumber):count/(page.pagenumber)+1;
        List<UserU> list = userUService.selectAllUserU(0);
        model.addAttribute("page1",page1);
        model.addAttribute("thispage",1);
        model.addAttribute("list",list);
        return "userulist";
    }
    //进入用户列表页面
    @RequestMapping("/list")
    public String list(Model model){

        Integer count=userUService.countByExample();
        Integer page1=count%(page.pagenumber)==0?count/(page.pagenumber):count/(page.pagenumber)+1;
        List<UserU> list = userUService.selectAllUserU(0);
        model.addAttribute("page1",page1);
        model.addAttribute("thispage",1);
        model.addAttribute("list",list);
        return "userulist";
    }
    //进入用户树页面
    @RequestMapping("/list1")
	public String login(Model model) {
		
		List<UserU> useru=userUService.getAllUserU();
		List<Dept> dept=deptService.getAllDept();
		StringBuffer sn=new StringBuffer();
		sn.append("[");
		sn=hhh(sn,useru,dept,0);
		sn.deleteCharAt(sn.length()-1);
		sn.append("]");
		String ss=sn.toString();
		model.addAttribute("ztreeno",ss);
		return "ztree";
	}
    //用户列表分页显示，5个一页
    @RequestMapping("/all")
    @ResponseBody
    public page selectalluser(page page1) {
        try{
            page1.setStatus(0);
            Integer count=userUService.countByExample();
            Integer page=count%(page1.getPagenumber())==0?count/(page1.getPagenumber()):count/(page1.getPagenumber())+1;
            page1.setCount(count);
            page1.setPage(page);
            if(page1.getThispage()>=page){
                page1.setThispage(page1.getThispage()-1);
            }
            List<UserU> list = userUService.selectAllUserU(page1.getThispage());
            JSONArray json=JSONArray.fromObject(list);
            page1.setJson(json);
        }catch (Exception e){
            page1.setStatus(1);
            page1.setMsg("请求失败");
        }

        return page1;
    }
    //根据id删除用户
    @RequestMapping("/dele")
    @ResponseBody
    public Integer dele(Integer uid,Integer thispage){
        userUService.deleteUserUById(uid);
        return thispage;
    }

    @RequestMapping("/updata")
    public String updata(Integer uid,Model model){
        UserU userU=userUService.getUserUById(uid);
        List<String> list=userUService.getUserUPower(userU.getUname());
        model.addAttribute(userU);
        model.addAttribute("list",list);
        return "updata";
    }

    @RequestMapping("/upu")
    public String upu(UserU userU,String[] power,HttpServletRequest request,@RequestParam(value = "photo", required = false) MultipartFile file){
    	 if(file.getOriginalFilename()!=null){
    		 String path = request.getSession().getServletContext().getRealPath("upload");  
    	        
    	       // file.getOriginalFilename()
    	        String fileName = new Date().getTime()+".jpg";  
    	          
    	        File targetFile = new File(path, fileName);  
    	        if(!targetFile.exists()){  
    	            targetFile.mkdirs();  
    	        }  
    	  
    	        //保存  
    	        try {  
    	            file.transferTo(targetFile);
    	        } catch (Exception e) {  
    	            e.printStackTrace();  
    	        }
    	        String fileUrl=request.getContextPath()+"/upload/"+fileName;
    	        userU.setImgsrc(fileUrl);
    	 }
        
        
    	userUService.deleteUserUPower(userU.getUname());
    	if(power!=null){
    		for(int i=0;i<power.length;i++){
                userUService.addUserUPower(userU.getUname(),power[i]);
            }
    	}
        userUService.updateByPrimaryKeySelective(userU);
        return "success";
    }
    
    @RequestMapping("/moveuser")
	@ResponseBody
	public String moveuser(Integer uid,Integer did) {
		int uu=-uid;
		userUService.updateDeptById(uu,did);
		return "success";
	}
    
    @RequestMapping("/removeuser")
	@ResponseBody
	public String removedept(Integer uid) {
		userUService.deleteUserUById(-uid);
		return "success";
	}
    
    @RequestMapping("/seleteuser")
   	@ResponseBody
   	public Result seleteuser(String uname) {
    	System.out.println(123);
    	System.out.println(uname);
   		UserU userU=userUService.getUserUByName(uname);
   		Result result=new Result();
   		if(userU==null){
   			result.setStatus(100);
   			result.setMsg("没有这个用户！");
   		}else{
   			result.setStatus(200);
   			result.setData(userU);
   			
   		}
   		return result;
   	}
    
    //拼接字符串，用户和部门的
    public StringBuffer hhh(StringBuffer sn,List<UserU> useru,List<Dept> dept,Integer i){
		for(Dept d:dept){
			if(d.getPid()==i){
				sn.append("{");
				sn.append("id:"+d.getDid());
				sn.append(",pId:"+d.getPid());
				sn.append(",name:'"+d.getDname());
				
				sn.append("'},");
				sn=hhh(sn,useru,dept,d.getDid());
				
			
		}
		
		}
		for(UserU u:useru){
			if(u.getDid()==i){
				sn.append("{");
				sn.append("id:-"+u.getUid());
				sn.append(",pId:"+i);
				sn.append(",name:'"+u.getUname());
				sn.append("'},");
			}
	}
		return sn;
	}
    //拼接字符串，只有部门的
    public StringBuffer hh(StringBuffer sn,List<Dept> dept,Integer i){
		for(Dept d:dept){
			if(d.getPid()==i){
				sn.append("{");
				sn.append("id:"+d.getDid());
				sn.append(",pId:"+d.getPid());
				sn.append(",name:'"+d.getDname());
				
				sn.append("'},");
				sn=hh(sn,dept,d.getDid());
				
			
		}
		
		}
		
		return sn;
	}
}